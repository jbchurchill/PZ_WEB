<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no"/>
    <title>Simple Map</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.10/js/esri/css/esri.css">
    <style>
      html, body, #mapDiv {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        background-color: #FFF;
        overflow: hidden;
        font-family: "Trebuchet MS";
      }
    </style>
    <script src="http://js.arcgis.com/3.10/"></script>
    <script>
      var map, zoom, center;

      require(["esri/map", 
      "esri/dijit/Popup", 
      "esri/layers/ArcGISDynamicMapServiceLayer", 
      "esri/symbols/SimpleFillSymbol", 
      "esri/symbols/SimpleLineSymbol", 
      "esri/Color", 
      "esri/tasks/IdentifyTask", 
      "esri/tasks/IdentifyParameters", 
      "esri/InfoTemplate",
      "dojo/domReady!"
      ], function(Map, Popup, ArcGISDynamicMapServiceLayer, SimpleFillSymbol, SimpleLineSymbol, Color, IdentifyTask, IdentifyParameters, InfoTemplate, on) {
        
        var popup = new Popup({
          fillSymbol: new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255,0,0]), 2), new Color([255,255,0,0.25]))
        }, dojo.create("div"));
        
        center = [-79.2, 39.5];
        zoom = 10;
        
        
        map = new Map("mapDiv", {
          basemap: "streets",
          center: center,
          zoom: zoom,
          infoWindow: popup
        });
        
        
        map.on("click", executeIdentifyTask);
        // fpFEMA_task = new IdentifyTask("https://hazards.fema.gov/gis/nfhl/services");
        fpFEMA_task = new IdentifyTask("https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer");
        
        identifyParams = new IdentifyParameters();
        identifyParams.tolerance = 3;
        identifyParams.returnGeometry = true;
        // identifyParams.layerIds = [1, 2, 3, 4, 5, 6, 8, 10];
        identifyParams.layerOption = IdentifyParameters.LAYER_OPTION_VISIBLE; // .LAYER_OPTION_ALL; 
        // setting LAYER_OPTION_VISIBLE was an important change, eliminating attempts to identify layers not within scale range.
        identifyParams.width  = map.width;
        identifyParams.height = map.height;        
        
        // var landBaseLayer = new ArcGISDynamicMapServiceLayer("http://gis.garrettcounty.org:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer",
        var layerFEMA = new ArcGISDynamicMapServiceLayer("https://hazards.fema.gov/gis/nfhl/rest/services/public/NFHL/MapServer", 
          {opacity:.55}); // , opacity:.55}); // NEW
        map.addLayer(layerFEMA);        
        
      function executeIdentifyTask(evt) {
        identifyParams.geometry = evt.mapPoint;
        identifyParams.mapExtent = map.extent;
       
        // layers that can be identified by "click"
        identifyParams.layerIds = [0, 3, 28];
        
        var deferred = fpFEMA_task.execute(identifyParams);
        
        deferred.addCallback(function(response) {     
          // response is an array of identify result objects    
          // Let's return an array of features.
          return dojo.map(response, function(result) {
            var feature = result.feature;
            feature.attributes.layerName = result.layerName;
            
            if (result.layerName === 'NFHL Availability'){
             var template = new esri.InfoTemplate("",
             "<span class=\"sectionhead\">Layer: NFHL Availability</span><br /><br /><hr>Study ID: ${STUDY_ID} <br />");
             feature.setInfoTemplate(template);
            }
            else if(result.layerName === 'Flood Hazard Zones'){
              console.log("Flood Zone: " + feature.attributes.FLD_ZONE);
              var template = new esri.InfoTemplate("", "<span class=\"sectionhead\">Layer: FEMA Flood Hazard Zones </span><br /><br /><hr>Flood Zone: ${FLD_ZONE} <br/>");
              feature.setInfoTemplate(template);
            }
            else if (result.layerName === 'FIRM Panels'){
              var template = new esri.InfoTemplate("",
              "<span class=\"sectionhead\">Layer: FIRM Panels</span><br /><br /><hr>DFIRM ID: ${DFIRM_ID} <br />");
              feature.setInfoTemplate(template);
            }
            else {
              console.log("Layer:" + result.layerName);
              // this doesn't appear to work
            }
            return feature;   
            
          // }, function(error) {console.log("Error: " + error);});
          });
          
        }); // end of deferred callback function
        // registry.byId("search").on("click", doFind);
        // InfoWindow expects an array of features from each deferred
        // object that you pass. If the response from the task execution 
        // above is not an array of features, then you need to add a callback
        // like the one above to post-process the response and return an
        // array of features.
        map.infoWindow.setFeatures([ deferred ]);
        map.infoWindow.show(evt.mapPoint);
        
      }; // end of function executeIdentifyTask
        
        
      });
    </script>
  </head>

  <body>
    <div id="mapDiv"></div>
  </body>
</html>