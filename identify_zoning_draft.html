<!DOCTYPE html>
<html> 
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=7, IE=9, IE=10">
    <!--The viewport meta tag is used to improve the presentation and behavior of the samples 
      on iOS devices-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Identify with Popup</title>
    <link rel="stylesheet" href="http://js.arcgis.com/3.9/js/dojo/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://js.arcgis.com/3.9/js/esri/css/esri.css">
    <style>
      html, body {
        height:100%;
        width:100%;
        margin:0;
        padding:0;
      }
      #mapDiv {
        height:100%;
        width: 100%;
        margin: 0.75em 0;
        padding: 0;
        border-top: 1px solid red;
      }
      #mapControls {
        height: 10%;
        width: 100%;
        background-color: red;
      }
      form#basemap {
        padding-top: 10px;
        padding-left: 5px;
      }
      .sectionhead {
        font-weight: bold;
        font-size: larger;
      }
      #messages{
        background-color: white;
        margin: 0.4em;
        padding: 0 0.2em;
      }
      .selType{
        float:left;
        margin: 0 2em 0 1em;
      }
    </style>

    <script>var dojoConfig = { parseOnLoad: true };</script>
    <script src="http://js.arcgis.com/3.9/"></script>
    <script>
    var map;
      var identifyTask, identifyParams;   
      require([
        "esri/map",  "esri/dijit/BasemapGallery", "esri/dijit/Popup", "esri/layers/ArcGISDynamicMapServiceLayer", "esri/tasks/query",
    "esri/toolbars/draw", "esri/tasks/IdentifyTask", 
    "esri/layers/FeatureLayer", "esri/tasks/IdentifyResult", "esri/tasks/IdentifyParameters", "esri/dijit/InfoWindow", "esri/symbols/SimpleFillSymbol", 
    "esri/symbols/SimpleLineSymbol", "esri/InfoTemplate", "dojo/_base/array", "dojo/_base/Color", "dojo/dom", "dojo/on", "dojo/parser", 
    "dijit/layout/BorderContainer", "dijit/layout/ContentPane", "dijit/TitlePane", "dijit/form/Button", "dijit/form/RadioButton",
      "dojo/domReady!"
      ], function(Map, BasemapGallery, Popup, ArcGISDynamicMapServiceLayer, Query, Draw, IdentifyTask, FeatureLayer, IdentifyResult, IdentifyParameters, InfoWindow, 
        SimpleFillSymbol, SimpleLineSymbol, InfoTemplate, arrayUtil, Color, dom, on, parser, BorderContainer, ContentPane, TitlePane, Button, RadioButton) {
     //setup the popup window 
     
        parser.parse();
        
        var popup = new Popup({
          fillSymbol: new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID, new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID, new Color([255,0,0]), 2), new Color([255,255,0,0.25]))
        }, dojo.create("div"));
   
        map = new Map("mapDiv", {
          basemap: "streets",
          center: [-79.2, 39.5],
          zoom: 10,
          infoWindow: popup
        });
        
        // <!-- FROM SELECT SCRIPT -->
        map.on("load", initSelectToolbar);
        // map.on("load", initSelectToolbar2);
        
         //add the basemap gallery, in this case we'll display maps from ArcGIS.com including bing maps
        var basemapGallery = new BasemapGallery({
          showArcGISBasemaps: true,
          map: map
        }, "basemapGallery");
        basemapGallery.startup();
        
        basemapGallery.on("error", function(msg) {
          console.log("basemap gallery error:  ", msg);
        });
        
        // IDENTIFY LAYERS
        var landBaseLayer = new ArcGISDynamicMapServiceLayer("http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer",{opacity:.55});
        map.addLayer(landBaseLayer);
        
        //////////////////////////////////////////////////////////////////////////////////////////////////////////
        // SELECT POINTS <!-- FROM SELECT SCRIPT --><!-- This is not correct since these are polygon symbol types -->
        var fieldsSelectionSymbol, content, infoTemplate, featureLayer, typeIsParcels = false;
        function setupSelections() {
          
          // var typeIsParcels = dom.byId("points");
          // typeIsParcels = document.getElementById("parcels");
          if (typeIsParcels) {
            
            fieldsSelectionSymbol = 
              new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
              new SimpleLineSymbol(SimpleLineSymbol.STYLE_DASHDOT,
              new Color([255, 0, 0]), 2), new Color([255, 255, 0, 0.5]));
            content = "Map: ${MAP}<br />Parcel: ${PARCEL}<br />" +
                "Lot: ${LOT}<br />Grid: ${GRID}<br />Tax ID: ${ACCTID}<br /><hr>";
            infoTemplate = new InfoTemplate("${FIELD_NAME}", content);
            
            // Parcels = Layer 8
            featureLayer = new FeatureLayer("http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer/8",
            {
              mode: FeatureLayer.MODE_ONDEMAND,
              outFields: ["*"]
            });
            featureLayer.on("selection-complete", sumSelectedParcelInfo);
            // alert("Geometry Type is Parcels"); // TESTING
          } else {
            fieldsSelectionSymbol = new esri.symbol.SimpleMarkerSymbol().setColor(new dojo.Color([0,255,255]));
            fieldsSelectionSymbol.setSize(9);
            content = "Address: ${ADDRESS}<br />" +
                  "City: ${CITY} <br /> Owner: ${OWNNAME1} ${OWNNAME2} <br /> Tax Id: ${ACCTID} <br /><hr>";
            infoTemplate = new InfoTemplate("${FIELD_NAME}", content);
            // Address Points = Layer 4
            featureLayer = new FeatureLayer("http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer/4",
              {
                mode: FeatureLayer.MODE_ONDEMAND,
                // infoTemplate: infoTemplate,
                outFields: ["*"]
              });
            featureLayer.on("selection-complete", sumSelectedPoints);
            // alert("Geometry Type is Points"); // TESTING
          }
          
        featureLayer.setSelectionSymbol(fieldsSelectionSymbol);  
        featureLayer.on("selection-clear", function () {
          dom.byId('messages').innerHTML = "<i>No Selected Point or Parcels</i>";
        });
        map.addLayer(featureLayer);
          
        }
        
        on(dom.byId("polys"), "click", function () {
          typeIsParcels = true;
          featureLayer.clearSelection();
          setupSelections();
          
        });
        on(dom.byId("points"), "click", function() {
          typeIsParcels = false;
          featureLayer.clearSelection();
          setupSelections();
        });

        // If Rectangle radio button is selected select by rectangle, if not, select by polygon
        on(dom.byId("selectPointsButton"), "click", function () {
          // setupSelections();
          var SelectRectangle = document.getElementById("rectangle").checked;
          if (SelectRectangle) {
          // selectionToolbar.activate(Draw.FREEHAND_POLYGON);
              selectionToolbar.activate(Draw.EXTENT);
          } else {
              selectionToolbar.activate(Draw.FREEHAND_POLYGON);
          }    
        });
        
        on(dom.byId("clearSelectionButton"), "click", function () {
          featureLayer.clearSelection();
        });

        function initSelectToolbar (event) {
          setupSelections();
          selectionToolbar = new Draw(event.map);
          var selectQuery = new Query();

          on(selectionToolbar, "DrawEnd", function (geometry) {
            selectionToolbar.deactivate();
            selectQuery.geometry = geometry;
            featureLayer.selectFeatures(selectQuery,
              FeatureLayer.SELECTION_NEW);
          });
        }
        
        // Determine how many points were selected and list the Addresses for each point
        function sumSelectedPoints (event) {
          var pointSum = 0;
          var arrStructNum = [];
          var strAddresses = "";
          //summarize the cumulative gas production to display
          arrayUtil.forEach(event.features, function (feature) {
            strAddresses += feature.attributes.ADDRESS + "<br />";
            arrStructNum.push(feature.attributes.ADDRESS);
            pointSum += 1; //feature.attributes.STRUCTURE_NUMBER;
            // alert(feature.attributes.ADDRESS);
          });
          dom.byId('messages').innerHTML = "<b>Number of Selected Points: " +
                                            pointSum + "</b><br />" + strAddresses; // 
                                            // + JSON.stringify(arrStructNum, null, 4);
        }
          
        function sumSelectedParcelInfo (event) {
          alert("HEY LOOKA THERE!");
        };
    //////////////////////////////////////////////////////////////////////////////////////////////////////////////
    // IDENTIFY LAYERS
    map.on("click", executeIdentifyTask);
      identifyTask = new IdentifyTask("http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer");
      
        identifyParams = new IdentifyParameters();
        identifyParams.tolerance = 3;
        identifyParams.returnGeometry = true;
        // identifyParams.layerIds = [1, 2, 3, 4, 5, 6, 8, 10];
        identifyParams.layerOption = IdentifyParameters.LAYER_OPTION_ALL;
        identifyParams.width  = map.width;
        identifyParams.height = map.height;
    });

      function executeIdentifyTask(evt) {
        identifyParams.geometry = evt.mapPoint;
        identifyParams.mapExtent = map.extent;
       
        var ZoningIsOn = document.getElementById("ZoneOn").checked;
        if (ZoningIsOn) {
          // alert("on");
          identifyParams.layerIds = [1, 2, 3, 4, 5, 6, 10];
        } else {
          // alert("off");
          identifyParams.layerIds = [1, 2, 3, 4, 5, 6, 8, 10];
        }  
        
        var deferred = identifyTask.execute(identifyParams);

        deferred.addCallback(function(response) {     
          // response is an array of identify result objects    
          // Let's return an array of features.
          return dojo.map(response, function(result) {
            var feature = result.feature;
            feature.attributes.layerName = result.layerName;
            
            if(result.layerName === 'County_Zoning_Layer'){
              console.log(feature.attributes.GENZONE);
              var template = new esri.InfoTemplate("", "<span class=\"sectionhead\">Layer: County Zoning Layer </span><br /><br /><hr>${GENZONE} <br/> Land Use Code: ${FLU}");
              feature.setInfoTemplate(template);
            }
            else if (result.layerName === 'Garrett.DBO.TaxParcel'){
            //   console.log(feature.attributes.ACCTID);
              var template = new esri.InfoTemplate("",
              "<span class=\"sectionhead\">Layer: Parcels</span><br /><br /><hr>Address: ${ADDRESS} <br />"
              + "City: ${CITY} <br /> Owner: ${OWNNAME1} ${OWNNAME2} <br /> Tax Id: ${ACCTID} <br /><hr><span class=\"sectionhead\">Deed Reference</span><br />"
              + "Liber: ${DR1LIBER} <br /> Folio: ${DR1FOLIO} <br /><hr> Subdivision: ${SUBDIVSN} <br /> Plat: ${PLAT} <br /> Block: ${BLOCK} <br /> Grid: ${GRID} <br />"
              + "Map: ${MAP} <br /> Parcel: ${PARCEL} <br /> Lot: ${LOT} <br /> Area: ${ACRES} Acres <br /><hr><span class=\"sectionhead\">Plat Reference</span><br />"
              + "Liber: ${PLTLIBER} <br /> Folio: ${PLTFOLIO} <br /><hr>"
              + "Year Built: ${YRBLT_CAMA} <br /> SDAT Link: <a href=\"${SDATWEBADR}\" target=\"_blank\">LINK</a> <br />");
              //   + "Address: ${ADDRESS} <br />"
              // );
              map.infoWindow.resize(250, 500);
              feature.setInfoTemplate(template);
            // need to replace Building Footprints with an actual existing layer in our Service
            // so far zoning is the only layer in the service.
            } else if (result.layerName === 'addresspoints'){
              var template = new esri.InfoTemplate("", 
              "<span class=\"sectionhead\">Layer: Address Points</span><br /><br /><hr>Address: ${ADDRESS} <br /><br /> City: ${CITY} <br /> Zip: ${ZIP_CODE} <br /> ESN: ${ESN} <br /> Community: ${COMMUNITY} <br /> Map: ${MAP} <br /> Parcel: ${PARCEL} <br />"
              + "Lot: ${LOT} <br /> Tract: ${TRACT} <br /> LU: ${LU} <br /> Key date: ${KEYDATE} <br /> Rental: ${RENTAL} <br />"
              + "Rental Co.: ${RENTAL_CO} <br /> Tax Account: ${TAX_ACCOUNT_ID} <br /> Owner: ${OWNER_FIRST_NAME} ${OWNER_LAST_NAME} <br />");
              feature.setInfoTemplate(template);
            } else if (result.layerName === 'Critical_Facilities') {
              var template = new esri.InfoTemplate("",
              "<span class=\"sectionhead\">Layer: Critical Facilities </span><br /><br /><hr>Land Use: ${LU} <br /> Address: ${ADDRESS} ${ROADNAME} <br /> Last Name: ${LASTNAME} <br /> ");
              feature.setInfoTemplate(template);
            } else if (result.layerName === 'celltowers') {
              var content = "Data Source: ${SOURCE_OF_DATA} <br />";
              // I AM TRYING TO DO THIS CONDITIONALLY BUT THIS CAUSES AN ERROR
              // if (${SOURCE_OF_DATA}) {
              // content+="Data Source: ${SOURCE_OF_DATA} <br />";
              // }
              var template = new esri.InfoTemplate("",
              "<span class=\"sectionhead\">Layer: Cell Towers</span><br /><br /><hr>Address: ${TOWER_ADDRESS} <br /> "
              + "Community: ${TOWER_COMMUNITY} <br /> Ground Elev: ${GROUND_ELEV} ${HEIGHT_ELEV_UNITS}<br /> Tower Ht: ${TOWER_HEIGHT} ${HEIGHT_ELEV_UNITS} <br />"
              + "Comments: ${COMMENTS} <br />" + content);
              feature.setInfoTemplate(template);
            } else if (result.layerName === 'centerlines') {
              var template = new esri.InfoTemplate("",
              "<span class=\"sectionhead\">Layer: Street Centerlines</span><br /><br /><hr>Name: ${STREET_ALL} <br />"
              + "Maintenance: ${MAINTENANCE} <br /> Length: ${SHAPE_Length:NumberFormat} feet <br />");
              // NumberFormat(round:1) // does not seem to work but just using NumberFormat gets it to 3 decimal places
              feature.setInfoTemplate(template);
            }
            return feature;
          });
        });

      
        // InfoWindow expects an array of features from each deferred
        // object that you pass. If the response from the task execution 
        // above is not an array of features, then you need to add a callback
        // like the one above to post-process the response and return an
        // array of features.
        map.infoWindow.setFeatures([ deferred ]);
        map.infoWindow.show(evt.mapPoint);
      }
      
      
    </script>
  </head>
  
  <body class="claro">
    <div data-dojo-type="dijit/layout/BorderContainer" 
         data-dojo-props="design:'headline', gutters:false" 
         style="width:100%;height:100%;margin:0;">
      
      <button id="selectPointsButton" data-dojo-type="dijit/form/Button">Select Points/Polys</button>
      <button id="clearSelectionButton" data-dojo-type="dijit/form/Button">Clear Selection</button>
      <div class="selType">
          <input type="radio" id="rectangle" name="selectType"  checked="true">Rectangle<br />
          <input type="radio" id="polygon" name="selectType">Polygon<br />
      </div>
      <div class="selType">
          <input type="radio" id="points" data-dojo-type="dijit/form/RadioButton" name="geomType" checked="true" />Address Points<br />
          <input type="radio" id="polys" data-dojo-type="dijit/form/RadioButton" name="geomType" />Parcels<br />
      </div>
      <!-- onclick="runTest();"  -->
      <div id="mapDiv" data-dojo-type="dijit/layout/ContentPane" 
           data-dojo-props="region:'center'" 
           style="padding:0;">
        <div style="position:absolute; right:20px; top:10px; z-Index:999;">
          <span id="messages"></span>  
          <div data-dojo-type="dijit/TitlePane" 
               data-dojo-props="title:'Switch Basemap', closable:false,  open:false">
            <div data-dojo-type="dijit/layout/ContentPane" style="width:380px; height:280px; overflow:auto;">
              <div id="basemapGallery" ></div>
            </div><!-- ContentPane 1 -->
          </div><!-- TitlePane 1 "Switch Basemap" -->  
          <div data-dojo-type="dijit/TitlePane" 
               data-dojo-props="title:'ID Zoning', closable:false,  open:false">
            <div data-dojo-type="dijit/layout/ContentPane" style="width:80px; height:50px; overflow:auto;">
              <div id="idZoning" >
                <form id="Zoning">
                  <input type="radio" id="ZoneOn" name="ZoningOn" />on<br />
                  <input type="radio" id="ZoneOff" name="ZoningOn" checked="true" />off<br />
                </form>
              </div><!-- idZoning -->
            </div><!-- ContentPane 2 -->
          </div><!-- Title Pane 2 "ID Zoning" -->     
        </div><!-- unnamed div -->
      </div><!-- mapDiv -->
    </div><!-- Border Container -->
  </body>
</html>