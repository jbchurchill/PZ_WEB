<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
  <head>
    <meta name="generator" content="HTML Tidy, see www.w3.org">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    
    <title>Populate dropdown list with unique values</title>
    
    <link rel="stylesheet" type="text/css" 
            href="http://serverapi.arcgisonline.com/jsapi/arcgis/1.5/js/dojo/dijit/themes/tundra/tundra.css">
    
    <style type="text/css">body,html,#main{margin:0;padding:0;height:100%;width:100%;}</style>
   
    <script type="text/javascript">var djConfig = { parseOnLoad:true }</script>
    <script type="text/javascript" src="http://serverapi.arcgisonline.com/jsapi/arcgis/?v=1.5"></script>
    <!-- <script>var dojoConfig = { parseOnLoad:true };</script> -->
    <!-- <script src="http://js.arcgis.com/3.9/"></script> -->
    
    <script type="text/javascript">
      dojo.require("esri.map");
      dojo.require("esri.tasks.query");
      dojo.require("dojo.parser");
      dojo.require("dijit.layout.BorderContainer");
      dojo.require("dijit.layout.ContentPane");
      dojo.require("dijit.form.ComboBox");
      dojo.require("dojo.data.ItemFileReadStore");

      var map, statesLayer;
      var resizeTimer;
      function init() {
        dojo.connect(dijit.byId('map'),'resize',function() {
          resizeMap();
        });
        // var queryTask = new esri.tasks.QueryTask("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Louisville/LOJIC_LandRecords_Louisville/MapServer/2");
        var queryTask = new esri.tasks.QueryTask("http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer/6");
        //Define query parameters
        var query = new esri.tasks.Query();
        query.outFields = ["RDNAMELOCAL"];
        query.returnGeometry = false;
        query.where  = "RDNAMELOCAL <> ''"
        queryTask.execute(query,populateList);

        var initialExtent = new esri.geometry.Extent(-78.60,38.90,-79.80,40.05,
        // var initialExtent = new esri.geometry.Extent(607677.496450, 569983.970130, 769859.218110, 757553.157184,
                new esri.SpatialReference({wkid:2248}) );
                // 4326 is the original
                // 102685 ???
                // 2248 (is FIPS1900)
        map = new esri.Map("map", {extent:initialExtent});

        //Create tiled and dynamic map services and add to the map - for the dynamic service set the transparency
        //and provide an id so we can access it later
        map.addLayer(new esri.layers.ArcGISTiledMapServiceLayer("http://server.arcgisonline.com/ArcGIS/rest/services/ESRI_StreetMap_World_2D/MapServer"));
        //map.addLayer(new esri.layers.ArcGISDynamicMapServiceLayer("http://sampleserver1.arcgisonline.com/ArcGIS/rest/services/Louisville/LOJIC_LandRecords_Louisville/MapServer",
        //        {"opacity":.4,"id":"dynamic"}));
                
        map.addLayer(new esri.layers.ArcGISDynamicMapServiceLayer("http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer",
                {"opacity":.4,"id":"dynamic"}));
                
        // ALL NEW FROM SAMPLE AT: http://developers.arcgis.com/javascript/samples/fl_zoomgrid/
        // Currently statesLayer (esri.layers.FeatureLayer) is NOT AVAILABLE in v1.5 of esri jsapi 
        // NEED TO SWITCH to v3.9 (uncomment from above) but that ruins the map !!!
        statesLayer = new esri.layers.FeatureLayer("http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer/6",{
          mode:esri.layers.FeatureLayer.MODE_SELECTION,
          outFields:["RDNAMELOCAL","MAINTENANCE","OBJECTID"]
        });

        dojo.connect(statesLayer,'onLoad',function(layer){     
          var query = new esri.tasks.Query();    
          query.where = "1=1";
          layer.queryFeatures(query,function(featureSet){
            var items = dojo.map(featureSet.features,function(feature){
              return feature.attributes;
            });
            var data = {
              identifier:"ObjectID",
              items:items};
            store = new dojo.data.ItemFileReadStore({data:data});
            grid.setStore(store);
            grid.setSortIndex(1,"true"); //sort on the state name          
          });
        });
        map.addLayers([statesLayer]);

                
        // map.addLayer(new esri.layers.FeatureLayer(http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer/6",
        //        {mode: FeatureLayer.MODE_SNAPSHOT,
		    //        outFields: ["RDNAMELOCAL", "MAINTENANCE"]});        
      }
       // map.addLayer(new esri.layers.FeatureLayer(http://192.168.100.35:6080/arcgis/rest/services/P_and_Z/Parcels_and_Zoning/MapServer/6",
      //          {mode: FeatureLayer.MODE_SNAPSHOT,
		  //          outFields: ["RDNAMELOCAL", "MAINTENANCE"]});

      function populateList(results) {
        //Populate the dropdown list box with unique values
        var zone;
        var values = [];
        var testVals={};

        //Add option to display all zoning types to the dropdown list 
        values.push({name:"ALL"})
        
        var features = results.features;
        dojo.forEach (features, function(feature) {
          zone = feature.attributes.RDNAMELOCAL;
          if (!testVals[zone]) {
            testVals[zone] = true;
            values.push({name:zone});
          }
        });
        
        var dataItems = {
               identifier: 'name',
               label: 'name',
               items: values
        };
        var store = new dojo.data.ItemFileReadStore({data:dataItems});
        dijit.byId("mySelect").store = store;
      }
      
      // Function from Sample at: http://developers.arcgis.com/javascript/samples/fl_zoomgrid/
      function zoomRow(id){
        statesLayer.clearSelection();
        var query = new esri.tasks.Query();
        query.where = "RDNAMELOCAL = '" + id + "'";
        // query.objectIds = [id];
        alert(query.where);
        statesLayer.selectFeatures(query,esri.layers.FeatureLayer.SELECTION_NEW,function(features){
          //zoom to the selected feature
          var stateExtent = features[0].geometry.getExtent().expand(5.0);
          map.setExtent(stateExtent);
        });
      }
      
      
      
      function applyLayerDef(selItem){
        //Filter the layer to display only the selected zoning types
        if (selItem.value !== 'ALL') {
          var layerDefs = [];
          layerDefs[2] = "RDNAMELOCAL = " + "'" + selItem.value + "'";
          layerDefs.visibleLayers = [2];
          map.getLayer("dynamic").setLayerDefinitions(layerDefs);
          zoomRow(selItem.value);
        }
        else {
          map.getLayer("dynamic").setDefaultLayerDefinitions();
        }
      }

      function resizeMap() {
        //Handle browser resize
        clearTimeout(resizeTimer);
        
        resizeTimer = setTimeout(function() {
          map.resize();
          map.reposition();
        }, 800);
      }

      dojo.addOnLoad(init);
    </script>
  </head>
  <body class="tundra">
    <div id="main" 
            dojotype="dijit.layout.BorderContainer"
            design="headline" 
            gutters="true">
      <div id="header"
             dojotype="dijit.layout.ContentPane"
             region="top"
             style="height:25px;">
        <select id="mySelect" 
             dojotype="dijit.form.ComboBox"
             style="width:300px;font-size:18px;"
             autoComplete="true"
             forceValidOption="false"
             value="Select Road Name"
             onchange="applyLayerDef(this)"></select>
      </div>
      <div id="map"
             dojotype="dijit.layout.ContentPane"
             region="center" 
             style="border:1px solid #000;margin:5px">
      </div>
    </div>
  </body>
</html>